name: Playwright Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    services:
      wordpress:
        image: bitnami/opencart:4
        ports:
          - '80:8080'
        env:
          OPENCART_HOST: localhost
          OPENCART_DATABASE_HOST: db
          OPENCART_DATABASE_PORT_NUMBER: 3306
          OPENCART_DATABASE_USER: opencart
          OPENCART_DATABASE_PASSWORD: opencart
          OPENCART_DATABASE_NAME: opencart
          ALLOW_EMPTY_PASSWORD: yes
          OPENCART_USERNAME: admin
          OPENCART_PASSWORD: parcelpro1
        options: --name opencart4
      db:
        image: mariadb:11
        ports:
          - '3306:3306'
        env:
          MARIADB_ALLOW_EMPTY_ROOT_PASSWORD: yes
          MARIADB_USER: opencart
          MARIADB_PASSWORD: opencart
          MARIADB_DATABASE: opencart
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 20
    - name: Install dependencies
      run: |
        npm ci
        npx playwright install chromium --with-deps
      working-directory: tests
    - name: Setup
      run: |
        wget -qO htmlq.tar.gz https://github.com/mgdm/htmlq/releases/latest/download/htmlq-x86_64-linux.tar.gz
        sudo tar xf htmlq.tar.gz -C /usr/local/bin
        ./install.sh
    - run: npm test
      working-directory: tests
      env:
        PP_USERNAME: ${{ secrets.PP_USERNAME }}
        PP_PASSWORD: ${{ secrets.PP_PASSWORD }}
    - uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: tests/playwright-report/
        retention-days: 30
